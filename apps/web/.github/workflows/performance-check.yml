name: Performance Check
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  packages: read
  pull-requests: write
  issues: write

jobs:
  performance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@sheenapps'

      - name: Install dependencies
        run: npm ci
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify no local symlinks in @sheenapps scope
        run: |
          if [ -d node_modules/@sheenapps ]; then
            SYMS=$(find node_modules/@sheenapps -maxdepth 2 -type l 2>/dev/null || true)
            if [ -n "$SYMS" ]; then
              echo "::error::Symlinks detected in node_modules/@sheenapps (CI must install from GitHub Packages):"
              echo "$SYMS"
              exit 1
            fi
          fi

      - name: Build application
        run: npm run build

      - name: Check bundle size limits (capture output)
        continue-on-error: true
        run: npm run size-limit 2>&1 | tee size-limit-output.txt

      - name: Run performance tests (capture output)
        continue-on-error: true
        run: npm run test:performance 2>&1 | tee perf-output.txt

      - name: Comment PR with performance results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let bundleOutput = 'Unable to read bundle size output';
            let perfOutput = '';
            let passed = true;

            try {
              bundleOutput = fs.readFileSync('size-limit-output.txt', 'utf8');
            } catch (e) {
              console.log('Could not read size-limit-output.txt');
            }

            try {
              perfOutput = fs.readFileSync('perf-output.txt', 'utf8');
              if (/FAIL|failed|Error/.test(perfOutput)) {
                passed = false;
              }
            } catch (e) {
              console.log('Could not read perf-output.txt');
              passed = false;
            }

            const perfStatus = passed
              ? '‚úÖ All performance requirements met'
              : '‚ùå Some performance tests failed';
            const statusLine = passed
              ? 'üü¢ **PASSED** - Ready to merge'
              : 'üî¥ **FAILED** - Fix performance issues';

            const comment = [
              '## üìä Performance Check Results',
              '',
              '### Bundle Size Analysis',
              '```',
              bundleOutput,
              '```',
              '',
              '### Performance Tests',
              perfStatus + ':',
              '- 50 history operations completed under 100ms',
              '- Memory usage within 5MB limit',
              '- State lookups under 10ms for 1000 operations',
              '',
              '### Status',
              statusLine
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Validate performance requirements (gate)
        if: always()
        run: |
          echo "üîç Checking performance test results..."
          FAIL=0

          if grep -Eq "FAIL|Error|failed" perf-output.txt 2>/dev/null; then
            echo "‚ùå Performance tests failed"
            FAIL=1
          fi

          if ! grep -q "handles 50 history operations under 100ms" perf-output.txt 2>/dev/null; then
            echo "‚ùå Performance requirement string not found (test output changed?)"
            FAIL=1
          fi

          if [ "$FAIL" -eq 1 ]; then
            echo "--- perf-output.txt ---"
            cat perf-output.txt || true
            exit 1
          fi

          echo "‚úÖ Performance requirements met"
