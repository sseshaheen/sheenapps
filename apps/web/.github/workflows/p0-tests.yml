name: P0 Critical Flow Tests

on:
  # Run on main branch pushes
  push:
    branches: [ main ]
  
  # Run on PRs to main
  pull_request:
    branches: [ main ]
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: false
        default: 'p0'
        type: choice
        options:
          - p0
          - smoke
          - all

# Cancel in-progress runs for same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

env:
  # Test environment configuration
  NODE_ENV: test
  TEST_MODE: true
  NEXT_TELEMETRY_DISABLED: 1
  
  # Test mode overrides for deterministic behavior
  AI_WORKER_MODE: stub
  FORCE_PAYMENT_PROVIDER: stripe
  STRIPE_WEBHOOK_TEST_BYPASS: true
  ALLOW_TEST_HEADERS: true
  DISABLE_EMAIL_DELIVERY: true
  
  # Mock services for testing
  MOCK_CALENDAR: true
  MOCK_VERCEL: true
  MOCK_GITHUB: true
  
  # Enable test mode detection
  NEXT_PUBLIC_ENABLE_TEST_MODE: true

jobs:
  p0-tests:
    name: P0 Critical Flow Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        test-suite:
          - payment-flows
          - advisor-flows
          - chat-flows
          - referral-export-flows
          - sdk-services  # SDK P0-A tests (storage, db, auth, jobs, email, payments, analytics, secrets)
      fail-fast: false # Continue running other test suites if one fails
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@sheenapps'

      - name: Install dependencies
        run: npm ci
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify no local symlinks in @sheenapps scope
        run: |
          if [ -d node_modules/@sheenapps ]; then
            SYMS=$(find node_modules/@sheenapps -maxdepth 2 -type l 2>/dev/null || true)
            if [ -n "$SYMS" ]; then
              echo "::error::Symlinks detected in node_modules/@sheenapps (CI must install from GitHub Packages):"
              echo "$SYMS"
              exit 1
            fi
          fi

      - name: Setup test environment
        run: |
          cp .env.test.local.example .env.test.local
          echo "BASE_URL=http://localhost:3000" >> .env.test.local
          echo "TEST_TYPE=p0" >> .env.test.local
      
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      
      - name: Lint and type check
        run: |
          npm run lint:critical
          npm run type-check
      
      - name: Build application
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true

      - name: Require test database secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_TEST_URL }}" ] || [ -z "${{ secrets.SUPABASE_TEST_ANON_KEY }}" ] || [ -z "${{ secrets.SUPABASE_TEST_SERVICE_KEY }}" ]; then
            echo "::error::Missing SUPABASE_TEST_URL, SUPABASE_TEST_ANON_KEY, or SUPABASE_TEST_SERVICE_KEY secrets"
            echo "P0 tests require a test database. Configure secrets or skip this workflow."
            exit 1
          fi

      - name: Seed test data
        run: npm run db:seed:test
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_TEST_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_TEST_ANON_KEY }}
      
      - name: Start application
        run: npm start &
        env:
          PORT: 3000
      
      - name: Wait for application
        run: npx wait-on http://localhost:3000 --timeout 120000
      
      - name: Run P0 tests - ${{ matrix.test-suite }}
        run: |
          if [ "${{ matrix.test-suite }}" = "sdk-services" ]; then
            # Run SDK P0-A tests from tests/e2e/p0-a/
            TEST_TYPE=p0a npx playwright test tests/e2e/p0-a/
          else
            npx playwright test p0-${{ matrix.test-suite }}.spec.ts
          fi
        env:
          TEST_TYPE: p0
          CI: true
          BASE_URL: http://localhost:3000

          # SDK E2E harness configuration
          SDK_E2E_ENABLED: true
          E2E_ADMIN_KEY: ${{ secrets.E2E_ADMIN_KEY }}

          # SDK test environment (CI-safe mode - no external services)
          SDK_E2E_CI_MODE: true
          SDK_E2E_STUB_STORAGE: true
          SDK_E2E_STUB_EMAIL: true
          SDK_E2E_STUB_PAYMENTS: true
          SDK_E2E_STUB_QUEUE: true

          # Test credentials
          TEST_EMAIL: ${{ secrets.TEST_EMAIL || 'test@example.com' }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD || 'TestPassword123!' }}

          # Payment testing (test keys only)
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_TEST_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_TEST_PUBLISHABLE_KEY }}

          # Database access for test cleanup
          SUPABASE_URL: ${{ secrets.SUPABASE_TEST_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_TEST_SERVICE_KEY }}
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: p0-test-results-${{ matrix.test-suite }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7
      
      - name: Upload failure screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: p0-failure-screenshots-${{ matrix.test-suite }}
          path: test-results/
          retention-days: 7
      
      - name: Clean up test data
        if: always()
        run: npm run db:seed:test cleanup
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_TEST_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_TEST_SERVICE_KEY }}

  # Smoke tests as backup/baseline
  smoke-tests:
    name: Smoke Tests (Baseline)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Only run smoke tests on manual trigger with 'smoke' or 'all' type
    if: github.event_name == 'workflow_dispatch' && (github.event.inputs.test_type == 'smoke' || github.event.inputs.test_type == 'all')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@sheenapps'

      - name: Install dependencies
        run: npm ci
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify no local symlinks in @sheenapps scope
        run: |
          if [ -d node_modules/@sheenapps ]; then
            SYMS=$(find node_modules/@sheenapps -maxdepth 2 -type l 2>/dev/null || true)
            if [ -n "$SYMS" ]; then
              echo "::error::Symlinks detected in node_modules/@sheenapps (CI must install from GitHub Packages):"
              echo "$SYMS"
              exit 1
            fi
          fi

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Build and start application
        run: |
          npm run build
          npm start &
          npx wait-on http://localhost:3000 --timeout 60000
        env:
          SKIP_ENV_VALIDATION: true
      
      - name: Run smoke tests
        run: npx playwright test
        env:
          TEST_TYPE: smoke
          CI: true
          BASE_URL: http://localhost:3000
      
      - name: Upload smoke test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 3

  # Test result summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [p0-tests, smoke-tests]
    if: always()
    
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results/
      
      - name: Generate test summary
        run: |
          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # P0 Test Results
          echo "### P0 Critical Flow Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.p0-tests.result }}" == "success" ]; then
            echo "âœ… **PASSED** - All critical flows working" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **FAILED** - Critical flows need attention" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Smoke Test Results
          echo "### Smoke Tests (Baseline)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.smoke-tests.result }}" == "success" ]; then
            echo "âœ… **PASSED** - Basic functionality working" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.smoke-tests.result }}" == "skipped" ]; then
            echo "â© **SKIPPED** - Only P0 tests requested" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **FAILED** - Basic functionality issues" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall Status
          if [ "${{ needs.p0-tests.result }}" == "success" ]; then
            echo "### ðŸš€ **DEPLOYMENT READY**" >> $GITHUB_STEP_SUMMARY
            echo "All critical user flows are working correctly." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ **DEPLOYMENT BLOCKED**" >> $GITHUB_STEP_SUMMARY
            echo "Critical user flows are failing. Review test results before deploying." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Set deployment status
        run: |
          if [ "${{ needs.p0-tests.result }}" == "success" ]; then
            echo "DEPLOYMENT_READY=true" >> $GITHUB_ENV
          else
            echo "DEPLOYMENT_READY=false" >> $GITHUB_ENV
            exit 1
          fi