name: Deploy

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'tsconfig.json'
      - 'ecosystem.config.js'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # Manual trigger for ad-hoc deployments

concurrency:
  group: worker-deploy
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e

            echo "=== Starting deployment ==="
            cd /home/worker/sheenapps-claude-worker

            echo "=== Fetching latest code ==="
            git fetch origin main
            git reset --hard origin/main

            echo "=== Installing dependencies ==="
            pnpm install --frozen-lockfile

            echo "=== Building ==="
            npm run build

            echo "=== Writing version file ==="
            echo "${{ github.sha }}" > .version

            echo "=== Restarting PM2 ==="
            pm2 startOrReload ecosystem.config.js --only sheenapps-claude-worker --update-env

            echo "=== Health check ==="
            for i in {1..12}; do
              if curl -sf http://localhost:3000/healthz | grep -q '"status"[[:space:]]*:[[:space:]]*"ok"'; then
                echo "Health check passed"
                echo "$(date -Iseconds) ${{ github.sha }} deployed" >> .deploy.log
                exit 0
              fi
              echo "Waiting for health check... attempt $i/12"
              sleep 5
            done

            echo "Health check failed after 60 seconds"
            exit 1
