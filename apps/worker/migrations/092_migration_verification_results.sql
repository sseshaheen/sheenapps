-- Migration: Migration Verification Results Table
-- Purpose: Store SHA-256 verification results with commit tracking for audit trail
-- Implements acceptance criteria: "Verification table row includes commit_sha, env, result, duration_ms"
-- Enhanced with expert feedback: append-only audit, semantic integrity, format validation
-- Date: 2025-09-17

BEGIN;

-- Create environment enum for consistency
DO $$
BEGIN
  CREATE TYPE mvr_env AS ENUM ('development','staging','production','test');
EXCEPTION
  WHEN duplicate_object THEN NULL;
END $$;

-- =====================================================
-- Migration Verification Results Table
-- =====================================================

CREATE TABLE IF NOT EXISTS migration_verification_results (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  domain VARCHAR(255) NOT NULL,
  file_url TEXT NOT NULL,
  expected_sha256 VARCHAR(64) NOT NULL,
  actual_sha256 VARCHAR(64),
  success BOOLEAN NOT NULL,
  environment mvr_env NOT NULL, -- Enum prevents drift
  commit_sha VARCHAR(40), -- Git commit SHA for traceability
  duration_ms INTEGER NOT NULL, -- Verification duration in milliseconds
  error_message TEXT,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),

  -- Enhanced data integrity constraints
  CONSTRAINT verification_results_sha256_hex CHECK (
    expected_sha256 ~ '^[0-9a-f]{64}$' AND
    (actual_sha256 IS NULL OR actual_sha256 ~ '^[0-9a-f]{64}$')
  ),
  CONSTRAINT verification_results_commit_hex CHECK (
    commit_sha IS NULL OR commit_sha ~ '^[0-9a-f]{40}$'
  ),
  CONSTRAINT verification_results_duration_positive CHECK (duration_ms >= 0),
  -- Semantic integrity: success must have matching hash, failure must have error
  CONSTRAINT mvr_success_matches_hash CHECK (
    (success = true AND actual_sha256 IS NOT NULL AND actual_sha256 = expected_sha256) OR
    (success = false AND error_message IS NOT NULL AND length(trim(error_message)) > 0)
  )
);

-- Create indexes for query performance
CREATE INDEX IF NOT EXISTS idx_verification_results_domain ON migration_verification_results(domain);
CREATE INDEX IF NOT EXISTS idx_verification_results_success ON migration_verification_results(success);
CREATE INDEX IF NOT EXISTS idx_verification_results_environment ON migration_verification_results(environment);
CREATE INDEX IF NOT EXISTS idx_verification_results_commit_sha ON migration_verification_results(commit_sha);

-- BRIN index for efficient time-range queries on large audit tables
CREATE INDEX IF NOT EXISTS brin_mvr_created_at
  ON migration_verification_results
  USING BRIN (created_at);

-- Composite index for common queries (domain + environment + time)
CREATE INDEX IF NOT EXISTS idx_verification_results_domain_env_time
  ON migration_verification_results(domain, environment, created_at DESC);

-- Corrected dedupe key - prevents logical duplicates by verification criteria, not timestamp
CREATE UNIQUE INDEX IF NOT EXISTS ux_mvr_dedupe
  ON migration_verification_results(domain, file_url, environment, commit_sha)
  WHERE commit_sha IS NOT NULL;

-- =====================================================
-- Append-Only Audit Protection
-- =====================================================

-- Function to prevent modifications to audit table
CREATE OR REPLACE FUNCTION _mvr_prevent_mod()
RETURNS trigger LANGUAGE plpgsql AS $$
BEGIN
  IF TG_OP IN ('UPDATE','DELETE') THEN
    RAISE EXCEPTION 'migration_verification_results is append-only (audit table)';
  END IF;
  RETURN NEW;
END $$;

-- Apply append-only protection
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'mvr_append_only' AND tgrelid = 'migration_verification_results'::regclass) THEN
    CREATE TRIGGER mvr_append_only
      BEFORE UPDATE OR DELETE ON migration_verification_results
      FOR EACH ROW EXECUTE FUNCTION _mvr_prevent_mod();
  END IF;
END $$;

-- =====================================================
-- Add comments for documentation
-- =====================================================

COMMENT ON TABLE migration_verification_results IS 'Append-only audit trail for migration domain verification with SHA-256 checksums and semantic integrity';
COMMENT ON COLUMN migration_verification_results.expected_sha256 IS 'SHA-256 hash of expected verification token (hex format)';
COMMENT ON COLUMN migration_verification_results.actual_sha256 IS 'SHA-256 hash of actual file content retrieved (hex format)';
COMMENT ON COLUMN migration_verification_results.commit_sha IS 'Git commit SHA when verification was performed (40-char hex)';
COMMENT ON COLUMN migration_verification_results.duration_ms IS 'Time taken for verification in milliseconds';
COMMENT ON COLUMN migration_verification_results.environment IS 'Deployment environment (enum: development, staging, production, test)';
COMMENT ON COLUMN migration_verification_results.error_message IS 'Error details when verification fails (required for success=false)';

COMMIT;

-- =====================================================
-- Migration Verification
-- =====================================================

DO $$
BEGIN
  -- Check table was created
  IF NOT EXISTS (SELECT 1 FROM information_schema.tables
                 WHERE table_name = 'migration_verification_results') THEN
    RAISE EXCEPTION 'Migration failed: migration_verification_results table not created';
  END IF;

  -- Check required columns exist
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                 WHERE table_name = 'migration_verification_results'
                 AND column_name = 'commit_sha') THEN
    RAISE EXCEPTION 'Migration failed: commit_sha column not added';
  END IF;

  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                 WHERE table_name = 'migration_verification_results'
                 AND column_name = 'duration_ms') THEN
    RAISE EXCEPTION 'Migration failed: duration_ms column not added';
  END IF;

  -- Check enhanced constraints exist
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'mvr_success_matches_hash') THEN
    RAISE EXCEPTION 'Migration failed: semantic integrity constraint not created';
  END IF;

  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'verification_results_sha256_hex') THEN
    RAISE EXCEPTION 'Migration failed: SHA256 hex format constraint not created';
  END IF;

  -- Check append-only protection
  IF NOT EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'mvr_append_only' AND tgrelid = 'migration_verification_results'::regclass) THEN
    RAISE EXCEPTION 'Migration failed: append-only protection not applied';
  END IF;

  -- Check environment enum
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'mvr_env') THEN
    RAISE EXCEPTION 'Migration failed: environment enum type not created';
  END IF;

  RAISE NOTICE 'âœ… Migration verification results table created successfully with expert enhancements';
END $$;